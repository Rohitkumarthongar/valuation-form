<!DOCTYPE html>
<html>

<head>
    <title>Jewelry Valuation Form</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            display: none;
            /* Hidden by default, shown via JS */
        }

        .container.active {
            display: block;
        }

        /* Landing Section Styles */
        .landing-container {
            max-width: 600px;
            margin: 100px auto;
            text-align: center;
        }

        .landing-btn {
            display: inline-block;
            width: 200px;
            padding: 20px;
            margin: 15px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
        }

        .landing-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-valuation {
            background-color: #3498db;
        }

        .btn-billing {
            background-color: #9b59b6;
        }

        h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .back-btn {
            background-color: #95a5a6;
            margin-bottom: 20px;
        }

        .back-btn:hover {
            background-color: #7f8c8d;
        }

        /* ... existing styles ... */
        .form-section {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .section-title {
            font-weight: bold;
            margin: 15px 0 10px;
            font-size: 18px;
            color: #2c3e50;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            background: white;
        }

        table,
        th,
        td {
            border: 1px solid #ddd;
        }

        th {
            background-color: #3498db;
            color: white;
            padding: 10px;
            text-align: left;
        }

        td {
            padding: 8px;
        }

        input,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        input:focus,
        select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        .delete-btn {
            background-color: transparent;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            /* Slight rounded square on hover */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: none;
            padding: 0;
            margin: 0 auto;
        }

        .delete-btn:hover {
            background-color: #ffecec;
            /* Very light red */
            transform: scale(1.1);
        }

        .delete-btn svg {
            width: 20px;
            /* Slightly larger */
            height: 20px;
            fill: #e74c3c;
            /* Red icon */
        }

        .error {
            color: #e74c3c;
            font-size: 14px;
            margin: 10px 0;
        }

        .flex-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .flex-row div {
            flex: 1;
            min-width: 200px;
        }

        .flex-row div:has(#aadhar_no) {
            flex: 1;
            /* Ensure it takes available space */
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .logo-preview {
            text-align: center;
            margin: 20px 0;
        }

        .logo-preview img {
            max-width: 150px;
            max-height: 100px;
        }
    </style>
</head>

<body>

    <div id="landing_section" class="landing-container">
        <h1>Jewelry Management System</h1>
        <button class="landing-btn btn-valuation" onclick="showSection('valuation_section')">üíé Valuation</button>
        <button class="landing-btn btn-billing" onclick="showSection('billing_section')">üßæ Billing</button>
    </div>

    <!-- Valuation Section -->
    <div id="valuation_section" class="container">
        <button class="back-btn" onclick="showLanding()">‚Üê Back to Home</button>
        <h2>Jewelry Valuation Form</h2>

        <!-- Customer Details -->
        <div class="form-section">
            <div class="section-title">Customer Details</div>
            <div class="flex-row">
                <div>
                    <label for="customer_name">Customer Name</label>
                    <input type="text" id="customer_name" required>
                </div>
                <div>
                    <label for="swd_name">S/W/D of</label>
                    <input type="text" id="swd_name" required>
                </div>
                <div>
                    <label for="resident">Resident of</label>
                    <input type="text" id="resident" required>
                </div>
            </div>
            <div class="flex-row">
                <div>
                    <label for="bank_branch">Bank Branch</label>
                    <input type="text" id="bank_branch" required>
                </div>
                <div>
                    <label for="acc_no">Account No.</label>
                    <input type="text" id="acc_no" required>
                </div>
                <div>
                    <label for="aadhar_no">Aadhar Number</label>
                    <input type="text" id="aadhar_no" required>
                </div>
                <div>
                    <label for="cashier">Cashier Name</label>
                    <input type="text" id="cashier" required>
                </div>
                <div>
                    <label for="transaction_date">Appraisal Date</label>
                    <input type="date" id="transaction_date" required>
                </div>
            </div>
        </div>

        <!-- Valuation Rate Table -->
        <div class="form-section">
            <div class="section-title">Valuation Rates</div>
            <table id="val_rate_table">
                <thead>
                    <tr>
                        <th style="width: 5%; text-align: center;">No.</th>
                        <th style="width: 20%;">Carat</th>
                        <th style="width: 20%;">Rate (‚Çπ/gram)</th>
                        <th style="width: 10%;">Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button onclick="addRateRow()">Add Rate</button>
        </div>

        <!-- Item Description Table -->
        <div class="form-section">
            <div class="section-title">Item Description</div>
            <table id="items_table">
                <thead>
                    <tr>
                        <th style="width: 5%; text-align: center;">No.</th>
                        <th style="width: 25%;">Description</th>
                        <th style="width: 5%;">Qty</th>
                        <th style="width: 10%;">Gross Weight (g)</th>
                        <th style="width: 15%;">Precious Stones (g)</th>
                        <th style="width: 10%;">Purity (K)</th>
                        <th style="width: 10%;">Net Weight (g)</th>
                        <th style="width: 15%;">Market Value (‚Çπ)</th>
                        <th style="width: 5%;">Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button onclick="addItemRow()">Add Item</button>
        </div>

        <div id="error_message" class="error"></div>

        <div class="action-buttons">
            <button onclick="resetForm()">Reset Form</button>
            <button onclick="generatePDF()" style="background-color: #27ae60;">Generate PDF</button>
        </div>
    </div>

    <!-- Billing Section -->
    <div id="billing_section" class="container">
        <button class="back-btn" onclick="showLanding()">‚Üê Back to Home</button>
        <h2>GST Billing Form</h2>

        <!-- Customer Details for Billing -->
        <div class="form-section">
            <div class="section-title">Customer Details</div>
            <div class="flex-row">
                <div>
                    <label>Customer Name</label>
                    <input type="text" id="bill_customer_name" required>
                </div>
                <div>
                    <label>Mobile No.</label>
                    <input type="text" id="bill_mobile" required>
                </div>
                <div>
                    <label>PAN Number</label>
                    <input type="text" id="bill_pan">
                </div>
                <div>
                    <label>GST No. (Optional)</label>
                    <input type="text" id="bill_gst">
                </div>
            </div>
            <div class="flex-row">
                <div>
                    <label>Bill No.</label>
                    <input type="text" id="bill_no" required>
                </div>
                <div>
                    <label>Bill Date</label>
                    <input type="date" id="bill_date" required>
                </div>
            </div>
        </div>

        <!-- Billing Rates Table (Added) -->
        <div class="form-section">
            <div class="section-title">Valuation Rates (Billing)</div>
            <table id="bill_rate_table">
                <thead>
                    <tr>
                        <th style="width: 5%; text-align: center;">No.</th>
                        <th style="width: 20%;">Carat</th>
                        <th style="width: 20%;">Rate (‚Çπ/gram)</th>
                        <th style="width: 10%;">Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button onclick="addBillRateRow()">Add Rate</button>
        </div>

        <!-- Billing Items Table -->
        <div class="form-section">
            <div class="section-title">Billing Items(Gold)</div>
            <table id="bill_items_table">
                <thead>
                    <tr>
                        <th style="width: 3%;">No.</th>
                        <th style="width: 20%;">Description</th>
                        <th style="width: 8%;">Purity</th>
                        <th style="width: 8%;">Gross Wt</th>
                        <th style="width: 8%;">Net Wt</th>
                        <th style="width: 5%;">Qty</th>
                        <th style="width: 8%;">Rate</th>
                        <th style="width: 8%;">Dia/Stn (Cts)</th>
                        <th style="width: 8%;">Making (%)</th>
                        <th style="width: 8%;">Dia/Stn Val</th>
                        <th style="width: 12%;">Amount (‚Çπ)</th>
                        <th style="width: 4%;">Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button onclick="addBillItemRow()">Add Item</button>
        </div>

        <!-- Silver Items Table (Added) -->
        <div class="form-section">
            <div class="section-title">Silver Items (Manual)</div>
            <table id="silver_table">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Qty</th>
                        <th>Amount (‚Çπ)</th>
                        <th style="width: 50px;">Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button onclick="addSilverRow()">Add Silver Item</button>
        </div>

        <!-- Tax & Payment Details -->
        <div class="form-section">
            <div class="section-title">Tax & Payment Details</div>
            <div class="flex-row">
                <div>
                    <label>CGST (%)</label>
                    <input type="number" id="tax_cgst" step="0.01" placeholder="e.g. 1.5">
                </div>
                <div>
                    <label>SGST (%)</label>
                    <input type="number" id="tax_sgst" step="0.01" placeholder="e.g. 1.5">
                </div>
                <div>
                    <label>IGST (%)</label>
                    <input type="number" id="tax_igst" step="0.01" placeholder="e.g. 3.0">
                </div>
            </div>

            <div class="flex-row">
                <div>
                    <label>Advance Payment (‚Çπ)</label>
                    <input type="number" id="payment_advance" step="0.01">
                </div>
            </div>

            <div class="section-title" style="margin-top:20px;">Received Payments</div>
            <table id="payment_table">
                <thead>
                    <tr>
                        <th>Mode</th>
                        <th>Reference / Cheque No.</th>
                        <th>Amount (‚Çπ)</th>
                        <th style="width: 50px;">Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button onclick="addPaymentRow()">Add Payment</button>
        </div>

        <div id="bill_error_message" class="error"></div>

        <div class="action-buttons">
            <button onclick="resetBillForm()">Reset Form</button>
            <button onclick="generateBillPDF()" style="background-color: #9b59b6;">Generate Bill PDF</button>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;

        // Trash Icon SVG
        const deleteIcon = `<svg viewBox="0 0 24 24"><path d="M3 6l3 18h12l3-18h-18zm19-4v2h-20v-2h5.711c.9 0 1.631-1.099 1.631-2h5.316c0 .901.73 2 1.631 2h5.711z"/></svg>`;

        // --- Navigation ---
        function showSection(sectionId) {
            document.querySelectorAll('.container, .landing-container').forEach(el => el.style.display = 'none');
            document.getElementById(sectionId).style.display = 'block';
            document.getElementById(sectionId).classList.add('active');
        }

        function showLanding() {
            document.querySelectorAll('.container').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active');
            });
            document.getElementById('landing_section').style.display = 'block';
        }

        // --- Shared / Utils ---
        function loadLogo() {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => resolve(null);
                img.src = 'logo.png';
            });
        }

        function showError(msg, elementId = "error_message") {
            document.getElementById(elementId).textContent = msg;
            setTimeout(() => document.getElementById(elementId).textContent = "", 5000);
        }

        function formatDate(dateStr) {
            if (!dateStr) return "";
            const date = new Date(dateStr);
            return `${String(date.getDate()).padStart(2, "0")}-${String(date.getMonth() + 1).padStart(2, "0")}-${date.getFullYear()}`;
        }

        // --- Valuation Form Logic (Existing) ---
        function addRateRow() {
            const table = document.querySelector("#val_rate_table tbody");
            const rowIndex = table.rows.length + 1;
            let row = table.insertRow();
            row.innerHTML = `
                <td><input type="text" value="${rowIndex}" readonly style="text-align: center;"></td>
                <td>
                    <select required>
                        <option value="" disabled selected>Select Carat</option>
                        <option value="18K">18K</option>
                        <option value="20K">20K</option>
                        <option value="22K">22K</option>
                    </select>
                </td>
                <td><input type="number" step="0.01" min="0" placeholder="Rate" required></td>
                <td style="text-align: center;"><button class="delete-btn" onclick="deleteRow(this)">${deleteIcon}</button></td>
            `;
        }

        function addItemRow() {
            const table = document.querySelector("#items_table tbody");
            const rowIndex = table.rows.length + 1;
            let row = table.insertRow();
            row.innerHTML = `
                <td><input type="text" value="${rowIndex}" readonly style="text-align: center;"></td>
                <td><input type="text" placeholder="Description" required></td>
                <td><input type="number" min="1" placeholder="Qty" required></td>
                <td><input type="number" step="0.01" min="0" placeholder="Gross" oninput="calcRow(this)" required></td>
                <td><input type="number" step="0.01" readonly></td>
                <td>
                    <select onchange="calcRow(this)" required>
                        <option value="" disabled selected>Select Purity</option>
                        <option value="18K">18K</option>
                        <option value="20K">20K</option>
                        <option value="22K">22K</option>
                    </select>
                </td>
                <td><input type="number" step="0.01" min="0" placeholder="Net" oninput="calcRow(this)" required></td>
                <td><input type="number" step="1" readonly></td>
                <td style="text-align: center;"><button class="delete-btn" onclick="deleteRow(this)">${deleteIcon}</button></td>
            `;
        }

        function deleteRow(btn) {
            const tbody = btn.closest("tbody");
            btn.closest("tr").remove();
            // Re-index
            let i = 1;
            for (let row of tbody.rows) {
                row.cells[0].querySelector("input").value = i++;
            }
        }

        function calcRow(el) {
            let row = el.closest("tr");
            let gross = parseFloat(row.cells[3].querySelector("input").value) || 0;
            let net = parseFloat(row.cells[6].querySelector("input").value) || 0;
            let purity = row.cells[5].querySelector("select").value.trim().toLowerCase();

            let additional = Math.abs(gross - net);
            row.cells[4].querySelector("input").value = additional.toFixed(2);

            let rate = getRateForPurity(purity);
            let value = rate ? Math.round(rate * net) : 0;
            row.cells[7].querySelector("input").value = value;
        }

        function getRateForPurity(purity) {
            let rows = document.querySelectorAll("#val_rate_table tbody tr");
            for (let r of rows) {
                let c = r.cells[1].querySelector("select").value.trim().toLowerCase();
                let rate = parseFloat(r.cells[2].querySelector("input").value) || 0;
                if (c === purity) return rate;
            }
            return null;
        }

        function resetForm() {
            if (confirm("Reset Valuation Form?")) {
                document.querySelector("#valuation_section").querySelectorAll("input, select").forEach(el => {
                    if (el.type != 'button') el.value = "";
                });
                document.querySelectorAll("#val_rate_table tbody, #items_table tbody").forEach(tb => tb.innerHTML = "");
                addRateRow();
                addItemRow();
            }
        }

        function validateValuation() {
            // Basic validation
            const name = document.getElementById("customer_name").value;
            if (!name) { showError("Customer Name required"); return false; }
            return true;
        }

        async function generatePDF() {
            if (!validateValuation()) return;
            // ... reusable code from previous version ...
            // (Truncated for brevity, I will re-include the logic but condensed or organized)
            // Actually, I should keep the original logic intact.
            // To save token space I'll focus on the new billing PDF, but I must ensure the old one works.
            // I'll copy the previous generatePDF logic here essentially.

            let doc = new jsPDF();
            let y = 10;

            try {
                const logo = await loadLogo();
                if (logo) doc.addImage(logo, 'PNG', 10, y, 40, 20);
            } catch (e) { }

            // Header - Right side text
            doc.setFontSize(10);
            doc.text("Rishabh Raj Soni", 190, y, { align: "right" });
            doc.setFont("helvetica", "bold");
            doc.text("GST No.: 08CXXPS2948K1ZR", 190, y + 5, { align: "right" });
            doc.text("ACC No.: 32008638787", 190, y + 10, { align: "right" });
            doc.text(" 41060977659", 190, y + 15, { align: "right" });
            y += 20;

            doc.setFontSize(20);
            doc.setFont("helvetica", "bold");
            doc.text("SAKSHI JEWELLERS", 105, y, { align: "center" });
            y += 6;
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Bus Stand, Danta (Sikar) Raj, 332702", 105, y, { align: "center" });
            y += 5;
            doc.text("Mob.: 9509409120, 8005629391", 105, y, { align: "center" });
            y += 10;

            doc.text("Annexure 10", 190, y, { align: "right" });
            y += 8;
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("APPRAISER CERTIFICATE", 105, y, { align: "center" });
            y += 10;

            // ... fields ...
            const bankBranch = document.getElementById("bank_branch").value;
            const accNo = document.getElementById("acc_no").value;
            const customerName = document.getElementById("customer_name").value;
            const swdName = document.getElementById("swd_name").value;
            const resident = document.getElementById("resident").value;
            const cashier = document.getElementById("cashier").value;
            const aadharNo = document.getElementById("aadhar_no").value;
            const transactionDate = formatDate(document.getElementById("transaction_date").value);

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`The Branch Manager`, 10, y); y += 5;
            doc.text(`State Bank of India`, 10, y); y += 5;
            doc.text(`Branch: ${bankBranch}`, 10, y); y += 8;
            doc.text(`Acc No.: ${accNo}`, 190, y, { align: "right" }); y += 5;
            doc.text(`Aadhar No.: ${aadharNo}`, 190, y, { align: "right" }); y += 8;
            doc.text("Dear Sir/Madam,", 10, y); y += 8;

            let cert = `I hereby certify that Sri/Smt. ${customerName}, S/W/D of ${swdName}, Resident of ${resident}, who has sought Gold Loan from the Bank is not my relative and the Gold against which the loan is sought is not purchased from me. The ornaments/Coins have been weighed and appraised by me on ${transactionDate} in the presence of Sri/Smt. ${cashier} and the exact weight, purity of the metal and market value of each item as on date are indicated below.`;
            doc.text(cert, 10, y, { maxWidth: 190 });
            y += doc.getTextDimensions(cert, { maxWidth: 190 }).h + 5;

            let valRates = [];
            document.querySelectorAll("#val_rate_table tbody tr").forEach(r => {
                valRates.push(`${r.cells[1].querySelector("select").value.trim()}-${parseInt(r.cells[2].querySelector("input").value).toLocaleString('en-IN')}`);
            });
            doc.text(`Market rate per gram: ${valRates.join(",")}`, 10, y, { maxWidth: 190 });
            y += 8;

            // ... table ...
            let items = [];
            let totalQty = 0, totalGross = 0, totalAdditional = 0, totalNet = 0, totalValue = 0;
            document.querySelectorAll("#items_table tbody tr").forEach((r, idx) => {
                let qty = parseInt(r.cells[2].querySelector("input").value) || 0;
                let gross = parseFloat(r.cells[3].querySelector("input").value) || 0;
                let add = parseFloat(r.cells[4].querySelector("input").value) || 0;
                let purity = r.cells[5].querySelector("select").value;
                let net = parseFloat(r.cells[6].querySelector("input").value) || 0;
                let val = parseInt(r.cells[7].querySelector("input").value) || 0;
                totalQty += qty; totalGross += gross; totalAdditional += add; totalNet += net; totalValue += val;

                items.push([
                    (idx + 1).toString(),
                    r.cells[1].querySelector("input").value,
                    qty.toString(),
                    `${gross.toFixed(2)} g`,
                    `${add.toFixed(2)} g`,
                    purity,
                    `${net.toFixed(2)} g`,
                    `${val.toLocaleString('en-IN')}`
                ]);
            });
            items.push([
                { content: "Total", colSpan: 2, styles: { halign: "right", fontStyle: "bold" } },
                { content: totalQty.toString(), styles: { fontStyle: "bold" } },
                { content: `${totalGross.toFixed(2)} g`, styles: { fontStyle: "bold" } },
                { content: `${totalAdditional.toFixed(2)} g`, styles: { fontStyle: "bold" } },
                { content: "", styles: { fontStyle: "bold" } },
                { content: `${totalNet.toFixed(2)} g`, styles: { fontStyle: "bold" } },
                { content: `${totalValue.toLocaleString('en-IN')}`, styles: { fontStyle: "bold" } }
            ]);

            doc.autoTable({
                head: [["No.", "Description of the Article", "Qty", "Gross Weight", "Precious Stones (g)", "Purity (K)", "Net Weight (g)", "Market Value"]],
                body: items,
                startY: y,
                styles: { fontSize: 8, cellPadding: 3, valign: 'middle', halign: 'left' },
                columnStyles: {
                    0: { cellWidth: 8, halign: 'center' },
                    1: { cellWidth: 'auto' },
                    2: { cellWidth: 10, halign: 'center' },
                    3: { cellWidth: 20, halign: 'right' },
                    4: { cellWidth: 25, halign: 'right' },
                    5: { cellWidth: 12, halign: 'center' },
                    6: { cellWidth: 20, halign: 'right' },
                    7: { cellWidth: 25, halign: 'right' }
                },
                theme: "grid",
                headStyles: { fillColor: [52, 152, 219], textColor: 255, fontStyle: 'bold' }
            });

            y = doc.lastAutoTable.finalY + 5;
            let dec = "I solemnly declare that weight, purity of the gold ornaments/precious stones indicated above are correct and I undertake to indemnify the Bank against any loss it may sustain on account of any inaccuracy in the above appraisal.";
            doc.text(dec, 10, y, { maxWidth: 190 });
            y += doc.getTextDimensions(dec, { maxWidth: 190 }).h + 5;

            doc.text(`Place: ${bankBranch}`, 10, y); y += 5;
            doc.text(`Date: ${transactionDate}`, 10, y); y += 8;

            doc.text("Yours faithfully,", 190, y, { align: "right" }); y += 5;
            doc.text("Name & Signature of the Appraiser: ______________", 190, y, { align: "right" }); y += 10;
            doc.text(`Name & Signature of the Borrower: ${customerName} ___________`, 10, y); y += 8;
            doc.text(`Cash in Charge/Cash Officer: ${cashier} _________________________`, 10, y); y += 5;
            doc.text("Accountant/Joint Custodian/Branch Manager: _________________", 190, y, { align: "right" });

            doc.save("appraiser_certificate.pdf");
        }


        // --- Billing Form Logic (NEW) ---
        function addBillRateRow() {
            const table = document.querySelector("#bill_rate_table tbody");
            const rowIndex = table.rows.length + 1;
            let row = table.insertRow();
            row.innerHTML = `
                <td><input type="text" value="${rowIndex}" readonly style="text-align: center;"></td>
                <td>
                    <select required>
                        <option value="" disabled selected>Select Carat</option>
                        <option value="18K">18K</option>
                        <option value="20K">20K</option>
                        <option value="22K">22K</option>
                        <option value="24K">24K</option>
                    </select>
                </td>
                <td><input type="number" step="0.01" min="0" placeholder="Rate" required></td>
                <td style="text-align: center;"><button class="delete-btn" onclick="deleteRow(this)">${deleteIcon}</button></td>
            `;
        }

        function addBillItemRow() {
            const table = document.querySelector("#bill_items_table tbody");
            const rowIndex = table.rows.length + 1;
            let row = table.insertRow();
            row.innerHTML = `
                <td><input type="text" value="${rowIndex}" readonly style="text-align: center; padding: 5px;"></td>
                <td><input type="text" placeholder="Description" required style="padding: 5px;"></td>
                <td><select onchange="updateBillRate(this)" style="padding: 5px;">
                    <option value="" disabled selected>Select</option>
                    <option value="18K">18K</option>
                    <option value="20K">20K</option>
                    <option value="22K">22K</option>
                    <option value="24K">24K</option>
                </select></td>
                <td><input type="number" step="0.01" min="0" placeholder="Gross" oninput="calcBillRow(this)" required style="padding: 5px;"></td>
                <td><input type="number" step="0.01" min="0" placeholder="Net" oninput="calcBillRow(this)" required style="padding: 5px;"></td>
                <td><input type="number" min="1" placeholder="Qty" oninput="calcBillRow(this)" required style="padding: 5px;"></td>
                <td><input type="number" step="0.01" min="0" placeholder="Rate" oninput="calcBillRow(this)" style="padding: 5px;"></td>
                <td><input type="text" placeholder="Cts" style="padding: 5px;"></td>
                <td><input type="number" step="0.01" min="0" placeholder="Mak %" oninput="calcBillRow(this)" style="padding: 5px;"></td>
                <td><input type="number" step="0.01" min="0" placeholder="Val" oninput="calcBillRow(this)" style="padding: 5px;"></td>
                <td><input type="number" step="0.01" min="0" placeholder="Amount" readonly style="background: #f9f9f9; padding: 5px;"></td>
                <td style="text-align: center;"><button class="delete-btn" onclick="deleteRow(this)">${deleteIcon}</button></td>
            `;
        }

        function updateBillRate(selectEl) {
            let row = selectEl.closest("tr");
            let purity = selectEl.value;
            let rate = getBillRateForPurity(purity);

            // Set the rate input if a rate is found
            if (rate) {
                row.cells[6].querySelector("input").value = rate;
            }
            // Trigger calculation
            calcBillRow(selectEl);
        }

        function getBillRateForPurity(purity) {
            let rows = document.querySelectorAll("#bill_rate_table tbody tr");
            for (let r of rows) {
                let c = r.cells[1].querySelector("select").value;
                let rate = parseFloat(r.cells[2].querySelector("input").value) || 0;
                if (c === purity) return rate;
            }
            return 0;
        }

        function calcBillRow(el) {
            let row = el.closest("tr");

            // Inputs
            let net = parseFloat(row.cells[4].querySelector("input").value) || 0;
            let rate = parseFloat(row.cells[6].querySelector("input").value) || 0;
            let makingPct = parseFloat(row.cells[8].querySelector("input").value) || 0;
            let diaVal = parseFloat(row.cells[9].querySelector("input").value) || 0;

            // Calculation:
            // Metal Value = Net * Rate
            // Making Amount = Metal Value * (MakingPct / 100)
            // Total = Metal Value + Making Amount + DiaVal

            let metalValue = net * rate;
            let makingAmt = metalValue * (makingPct / 100);
            let total = metalValue + makingAmt + diaVal;

            row.cells[10].querySelector("input").value = total.toFixed(2);
            calcBillTotal();
        }

        function calcBillTotal() {
            // Placeholder
        }

        function addPaymentRow() {
            const table = document.querySelector("#payment_table tbody");
            let row = table.insertRow();
            row.innerHTML = `
                <td>
                    <select class="pay-mode">
                        <option value="Cash">Cash</option>
                        <option value="Cheque">Cheque</option>
                        <option value="UPI">UPI</option>
                        <option value="Card">Card</option>
                    </select>
                </td>
                <td><input type="text" placeholder="Ref No / Detials"></td>
                <td><input type="number" step="0.01" placeholder="Amount"></td>
                <td style="text-align: center;"><button class="delete-btn" onclick="deleteRow(this)">${deleteIcon}</button></td>
            `;
        }

        function addSilverRow() {
            const table = document.querySelector("#silver_table tbody");
            let row = table.insertRow();
            row.innerHTML = `
                <td><input type="text" placeholder="Description"></td>
                <td><input type="number" step="1" placeholder="Qty"></td>
                <td><input type="number" step="0.01" placeholder="Amount"></td>
                <td style="text-align: center;"><button class="delete-btn" onclick="deleteRow(this)">${deleteIcon}</button></td>
            `;
        }

        function resetBillForm() {
            if (confirm("Reset Billing Form?")) {
                document.querySelector("#billing_section").querySelectorAll("input, select").forEach(el => {
                    if (el.type != 'button') el.value = "";
                });
                // Clear tables
                document.querySelector("#bill_rate_table tbody").innerHTML = "";
                document.querySelector("#bill_items_table tbody").innerHTML = "";
                document.querySelector("#payment_table tbody").innerHTML = "";
                // Add initial rows
                addBillRateRow();
                addBillItemRow();
                addPaymentRow();
            }
        }

        function numberToWords(num) {
            const a = ['', 'One ', 'Two ', 'Three ', 'Four ', 'Five ', 'Six ', 'Seven ', 'Eight ', 'Nine ', 'Ten ', 'Eleven ', 'Twelve ', 'Thirteen ', 'Fourteen ', 'Fifteen ', 'Sixteen ', 'Seventeen ', 'Eighteen ', 'Nineteen '];
            const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            const n = num.toString();
            if (n.length > 9) return 'overflow';

            const makeWords = (n) => {
                if ((n = n.toString()).length > 9) return 'overflow';
                const n_array = ('000000000' + n).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
                if (!n_array) return;
                let str = '';
                str += (n_array[1] != 0) ? (a[Number(n_array[1])] || b[n_array[1][0]] + ' ' + a[n_array[1][1]]) + 'Crore ' : '';
                str += (n_array[2] != 0) ? (a[Number(n_array[2])] || b[n_array[2][0]] + ' ' + a[n_array[2][1]]) + 'Lakh ' : '';
                str += (n_array[3] != 0) ? (a[Number(n_array[3])] || b[n_array[3][0]] + ' ' + a[n_array[3][1]]) + 'Thousand ' : '';
                str += (n_array[4] != 0) ? (a[Number(n_array[4])] || b[n_array[4][0]] + ' ' + a[n_array[4][1]]) + 'Hundred ' : '';
                str += (n_array[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n_array[5])] || b[n_array[5][0]] + ' ' + a[n_array[5][1]]) : '';
                return str;
            }

            let parts = n.split('.');
            let whole = makeWords(parseInt(parts[0]));
            if (parts[1]) {
                return `${whole}Rupees and ${makeWords(parseInt(parts[1].padEnd(2, '0').substring(0, 2)))} Paise Only`;
            }
            return whole + 'Rupees Only';
        }

        async function generateBillPDF() {
            // 1. Gather Data
            const custName = document.getElementById("bill_customer_name").value;
            const mobile = document.getElementById("bill_mobile").value;
            const pan = document.getElementById("bill_pan").value;
            const gst = document.getElementById("bill_gst").value;
            const billNo = document.getElementById("bill_no").value;
            const billDate = formatDate(document.getElementById("bill_date").value);

            if (!custName || !billNo || !billDate) {
                showError("Please fill Customer Name, Bill No and Date", "bill_error_message");
                return;
            }

            // Items Calculation
            let tableData = [];
            let totalTaxable = 0;
            let totalGross = 0;
            let totalNet = 0;
            let totalDiaVal = 0;

            document.querySelectorAll("#bill_items_table tbody tr").forEach((r, i) => {
                let desc = r.cells[1].querySelector("input").value;
                let purity = r.cells[2].querySelector("select").value;
                let gross = parseFloat(r.cells[3].querySelector("input").value) || 0;
                let net = parseFloat(r.cells[4].querySelector("input").value) || 0;
                let qty = r.cells[5].querySelector("input").value;
                let rate = r.cells[6].querySelector("input").value;
                let diaCts = r.cells[7].querySelector("input").value;
                let making = r.cells[8].querySelector("input").value;
                let diaVal = parseFloat(r.cells[9].querySelector("input").value) || 0;
                let amt = parseFloat(r.cells[10].querySelector("input").value) || 0;

                totalTaxable += amt;
                totalGross += gross;
                totalNet += net;
                totalDiaVal += diaVal;

                tableData.push([
                    (i + 1),
                    desc,
                    purity,
                    gross.toFixed(3),
                    net.toFixed(3),
                    qty,
                    rate,
                    diaCts,
                    making + '%',
                    diaVal ? diaVal.toFixed(2) : '-',
                    amt.toFixed(2)
                ]);
            });

            // Collect Silver Items
            document.querySelectorAll("#silver_table tbody tr").forEach(r => {
                const cells = r.cells;
                const desc = cells[0].querySelector("input").value.trim();
                const qty = cells[1].querySelector("input").value || "-";
                const amt = parseFloat(cells[2].querySelector("input").value) || 0;

                if (desc || amt > 0) {
                    totalTaxable += amt; // Add to taxable amount
                    tableData.push([
                        tableData.length + 1,
                        desc,
                        "-", "-", "-", // Purity, Gross, Net
                        qty,
                        "-", "-", "-", "-", // Rate, Dia, Mak, DiaVal
                        amt.toFixed(2)
                    ]);
                }
            });

            if (tableData.length === 0) {
                showError("Add at least one item (Gold or Silver)", "bill_error_message"); return;
            }

            // Taxes
            const cgstRate = parseFloat(document.getElementById("tax_cgst").value) || 0;
            const sgstRate = parseFloat(document.getElementById("tax_sgst").value) || 0;
            const igstRate = parseFloat(document.getElementById("tax_igst").value) || 0;

            const cgstAmt = totalTaxable * (cgstRate / 100);
            const sgstAmt = totalTaxable * (sgstRate / 100);
            const igstAmt = totalTaxable * (igstRate / 100);

            let finalAmount = totalTaxable + cgstAmt + sgstAmt + igstAmt;
            const roundOff = Math.round(finalAmount) - finalAmount;
            finalAmount = Math.round(finalAmount);

            // Payments
            let payments = [];
            let totalPaid = 0;
            document.querySelectorAll("#payment_table tbody tr").forEach(r => {
                let mode = r.cells[0].querySelector("select").value;
                let ref = r.cells[1].querySelector("input").value;
                let amt = parseFloat(r.cells[2].querySelector("input").value) || 0;
                if (amt > 0) {
                    payments.push({ mode, ref, amt });
                    totalPaid += amt;
                }
            });
            const advance = parseFloat(document.getElementById('payment_advance').value) || 0;
            if (advance > 0) {
                totalPaid += advance;
                payments.unshift({ mode: "Advance", ref: "-", amt: advance });
            }

            const balance = finalAmount - totalPaid;

            // --- Construct Complex Table Body ---
            // 1. Total Row
            tableData.push([
                { content: 'Total', colSpan: 3, styles: { halign: 'right', fontStyle: 'bold' } },
                { content: totalGross.toFixed(3), styles: { fontStyle: 'bold' } },
                { content: totalNet.toFixed(3), styles: { fontStyle: 'bold' } },
                { content: '', colSpan: 4 },
                { content: totalDiaVal.toFixed(2), styles: { fontStyle: 'bold' } },
                { content: totalTaxable.toFixed(2), styles: { fontStyle: 'bold' } }
            ]);

            // 2. Taxes
            if (sgstRate > 0) {
                tableData.push([
                    { content: `SGST ${sgstRate.toFixed(2)}%`, colSpan: 10, styles: { halign: 'right' } },
                    { content: sgstAmt.toFixed(2) }
                ]);
            }
            if (cgstRate > 0) {
                tableData.push([
                    { content: `CGST ${cgstRate.toFixed(2)}%`, colSpan: 10, styles: { halign: 'right' } },
                    { content: cgstAmt.toFixed(2) }
                ]);
            }
            if (igstRate > 0) {
                tableData.push([
                    { content: `IGST ${igstRate.toFixed(2)}%`, colSpan: 10, styles: { halign: 'right' } },
                    { content: igstAmt.toFixed(2) }
                ]);
            }

            // 3. Amount Words & Grand Total
            const grandTotalWords = numberToWords(finalAmount);
            tableData.push([
                { content: `Total In Words: ${grandTotalWords}`, colSpan: 10, styles: { fontStyle: 'italic' } },
                { content: finalAmount.toFixed(2), styles: { fontStyle: 'bold', fillColor: [230, 230, 230] } }
            ]);

            if (roundOff !== 0) {
                tableData.push([
                    { content: 'Round Off', colSpan: 10, styles: { halign: 'right' } },
                    { content: roundOff.toFixed(2) }
                ]);
            }

            // 4. Receipts
            payments.forEach(p => {
                tableData.push([
                    { content: `RECEIPT (${p.mode} - ${p.ref})`, colSpan: 10, styles: { halign: 'right' } },
                    { content: `-${p.amt.toFixed(2)}` }
                ]);
            });

            // 5. Balance
            const balanceWords = numberToWords(Math.round(balance));
            tableData.push([
                { content: `Balance In Words: ${balanceWords}`, colSpan: 8, styles: { fontStyle: 'italic', fontStyle: 'bold' } },
                { content: 'Balance Amount', colSpan: 2, styles: { halign: 'right', fontStyle: 'bold' } },
                { content: balance.toFixed(2), styles: { fontStyle: 'bold', fontSize: 10 } }
            ]);

            // --- Generate PDF ---
            let doc = new jsPDF();
            let y = 10;

            try {
                const logo = await loadLogo();
                if (logo) doc.addImage(logo, 'PNG', 4, y, 40, 20);
            } catch (e) { }

            // Header (Matches Valuation Form)
            doc.setFontSize(10);
            doc.text("Rishabh Raj Soni", 206, y, { align: "right" });
            doc.setFont("helvetica", "bold");
            doc.text("GST No.: 08CXHPS2948K1ZR", 206, y + 5, { align: "right" });
            doc.text("ACC No.: 32008638787", 206, y + 10, { align: "right" });
            doc.text(" 41060977659", 206, y + 15, { align: "right" });
            y += 20;

            doc.setFontSize(20);
            doc.setFont("helvetica", "bold");
            doc.text("SAKSHI JEWELLERS", 105, y, { align: "center" });
            y += 6;
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Bus Stand, Danta (Sikar) Raj, 332702", 105, y, { align: "center" });
            y += 5;
            doc.text("Mob.: 9509409120, 8005629391", 105, y, { align: "center" });
            y += 10;

            doc.line(4, y, 206, y);
            y += 5;

            // Customer & Invoice Info
            doc.setFontSize(11);
            doc.text("Details of Receiver / Billed to:", 4, y);
            doc.text("Invoice Details:", 140, y);
            y += 5;

            doc.setFontSize(10);
            doc.text(`Name: ${custName}`, 4, y);
            doc.text(`Invoice No: ${billNo}`, 140, y);
            y += 5;
            doc.text(`Mobile: ${mobile}`, 4, y);
            doc.text(`Date: ${billDate}`, 140, y);
            y += 5;
            if (pan) { doc.text(`PAN: ${pan}`, 4, y); }
            if (gst) { doc.text(`GSTIN: ${gst}`, 140, y); }
            y += 10;

            // Items Table
            doc.autoTable({
                head: [["No.", "Description", "Purity", "Gross", "Net", "Qty", "Rate", "Dia/Stn", "Making (%)", "Dia Val", "Amount"]],
                body: tableData,
                startY: y,
                theme: 'grid',
                styles: { fontSize: 8, cellPadding: 2, valign: 'middle' },
                headStyles: { fillColor: [155, 89, 182] },
                margin: { left: 4, right: 4 },
                columnStyles: {
                    0: { cellWidth: 8 },
                    1: { cellWidth: 'auto' }, // Desc
                    2: { cellWidth: 10 },
                    3: { cellWidth: 14, halign: 'right' }, // Gross
                    4: { cellWidth: 14, halign: 'right' }, // Net
                    5: { cellWidth: 8, halign: 'center' }, // Qty
                    6: { cellWidth: 14, halign: 'right' },
                    7: { cellWidth: 14, halign: 'right' },
                    8: { cellWidth: 14, halign: 'right' },
                    9: { cellWidth: 15, halign: 'right' },
                    10: { cellWidth: 22, halign: 'right' } // Amount
                }
            });
            y = doc.lastAutoTable.finalY + 5;

            doc.save(`${billNo} - ${custName} - ${billDate}.pdf`);
        }

        // Init
        window.onload = function () {
            showLanding();
            addRateRow();
            addItemRow();
            // Billing Init
            addBillRateRow();
            addBillItemRow();
            addSilverRow();
            addPaymentRow();
        };
    </script>
</body>

</html>